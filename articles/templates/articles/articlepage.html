{% extends 'base.html' %}
{% block title %} {{article.title}} {% endblock %}
{% load widget_tweaks %}

{% block 'content' %}
{% load markdown_extras %}


<div class="rounded-lg bg-base-300/50">
    <img class="object-cover w-full md:h-[800px] lg:h-[600px] sm:h-full" src="/{{ article.cover }}" alt="{{ article.title }}" />
    <h1 class="my-4 mb-10 text-6xl text-center">{{ article.title }}</h1>
    <div class="p-10">

        <div class="flex flex-col justify-center">
            <div class="avatar">
                <div class="w-24 mask mask-hexagon">
                    <img src="/{{author.avatar}}" alt="author avatar"/>
                </div>
            </div>

            <a href="{% url 'author_profile' author_username %}" class="mt-5 ml-3 font-bold hover:text-primary">@{%if author == user%}you{%else%}{{author}}{%endif%}</a>
        </div>
        
        <div class="flex items-center my-2 mt-6 space-x-2">
            <span class="badge badge-danger">date :</span>
            <span class="font-bold">{{article.date_published}}</span>
        </div>
        
        <div class="my-4 divider"></div>

        <div id="markdown">{{article.markdown | markdown | safe}}</div>
    </div>
</div>


<!-- comments -->
<button class="fixed right-0 z-90 top-1/2 btn btn-lg btn-secondary" onclick="showcomments()"><i class="fa fa-comments"></i></button>

<div class="fixed z-[99999] top-0 left-0 bottom-0 bg-black/50 w-full md:w-1/4 lg:w-2/3 hidden transition ease-in-out" id="overlay"></div>

<div id="comments" class="h-screen fixed z-[99999] bg-base-300/80 backdrop-blur-lg right-0 top-0 bottom-0 w-full md:w-9/12 lg:w-1/3 transition overflow-y-auto ease-in-out translate-x-full">
    <button onclick="hideComments()" class="p-4 mt-2 mb-4 ml-2 rounded-full md:hidden btn btn-lg"><i class="fa fa-times"></i></button>
    
    {% if user.is_authenticated %}
    <form id="comment_form" action="{% url 'add_comment' %}" method="POST" class="w-full p-4">
        {% csrf_token %}
        <div class="p-2">
            {{ comment_form.comment |add_class:"textarea text-lg bg-base-100/50 w-full h-40 resize-none" |append_attr:"id:comment-text"|append_attr:"placeholder:write a comment..."}}
            <input hidden name="article_id" value="{{article.pk}}"/>
            <button type="submit" class="mt-2 btn btn-info">comment</button>
        </div>
    </form>
    {%else%}
    <a href="{% url 'author_login'%}" class="m-2 my-4 btn">Log in to write a comment</a>
    {% endif %}


    <div id="comments-list" class="p-7"></div>
</div>
{% endblock %}


{% block 'scripts' %}
<script type="text/javascript">
    let commentsLoaded = false

    $('#overlay').on('click' , () => {
        hideComments()
    })
    $(document).ready(() => {

        $('#markdown a').addClass('link text-blue-500 ')
        $('#markdown a').attr('target' , '_blank')
        
        // code
        $('#markdown pre').wrap('<div class="mockup-code"></div>')


        $('#markdown h1').addClass('text-6xl')
        $('#markdown h2').addClass('text-5xl')
        $('#markdown h3').addClass('text-4xl')
        $('#markdown h4').addClass('text-3xl')
        $('#markdown h5').addClass('text-2xl')
        $('#markdown h6').addClass('text-lg')
        
        
        $('#markdown :header').addClass('font-bold border-b-[1px] border-gray-400 mt-3 mb-5 py-4')

        $('#markdown blockquote').addClass('border-l-2 p-3 bg-base-100')



})

const getHtmlComment = (comment) => {
    return `
    <div class="flex items-start px-2 py-4 mb-3 transition ease-in-out bg-base-100">
        <div class="w-20">
            <img class="object-cover object-center w-20 h-20 overflow-hidden rounded-full" src="/${comment.author__avatar}" alt="avatar" />
        </div> 
        <div class="flex-1 px-4">
            <a href="/author/${comment.author__username.replace(' ' , '-')}/profile" class="font-bold text-white">${comment.author__username}</a>
            <p class="mt-1 text-2xl">${comment.comment}</p>
        </div>
    </div>
    `
}

const mapComments = (comments) => {
    comments.forEach(comment => {
        $('#comments-list').append(getHtmlComment(comment))
    });
}

const showcomments = () => {
$('#comments').removeClass('translate-x-full')
$('#overlay').removeClass('hidden')
    // get comments
    if(!commentsLoaded){
        
        $.ajax({
            type: 'GET',
            url: "{% url 'article_comments' %}",
            data: {"article_title": "{{ article.title }}"},
            success: function (response) {
              if(response.length == 0) {
                $('#comments-list').append('<p class="my-2 text-4xl text-center" id="no-comments">No comments yet</p>')
              }
              mapComments(response)
              commentsLoaded = true
              console.log("made a request");
            },
            error: function (error) {
                console.log(error)
            }
        })


    }
}
const hideComments = () => {
$('#comments').addClass('translate-x-full')
$('#overlay').addClass('hidden')

}


// submitting comments
$('#comment_form').on('submit' , (e) => {
    e.preventDefault()
    var serializedData = $('#comment_form').serialize();
    $.ajax({
            type: 'POST',
            url: "{% url 'add_comment' %}",
            data: serializedData,
            success: function (response) {
                nocomments = $('#no-comments')
                if(nocomments) nocomments.remove()
                $('#comments-list').hide();
                $('#comments-list').prepend(getHtmlComment(response))
                $('#comments-list').slideToggle();
            },
            error: function (error) {
                console.log(error);
            }
        })

    $('#comment_form textarea').val('')
    $('#comment_form textarea').blur()

})
</script>
{% endblock %}